<% html_title('Issue EVM') %>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'issue_evm',               :plugin => 'redmine_issue_evm' %>
  <%= javascript_include_tag 'drawchart',            :plugin => 'redmine_issue_evm' %>
  <%= javascript_include_tag 'highcharts.js',        :plugin => 'redmine_issue_evm' %>
  <%= javascript_include_tag '../../../javascripts/select_list_move', :plugin => 'redmine_issue_evm' %>
  <script>
    function disableobject( object, ischecked ) {
      document.getElementById(object).disabled = ischecked;
    }
  </script>
<% end %>
<!-- Basline setting -->
<div class="contextual">
  <%= link_to l(:label_baseline_set), {controller:"evmbaselines", action:"index", id: @project.id} ,:class => 'icon icon-edit'%>
</div>
<!--Header-->
<h2 id="evm-title"><%=l(:title_evm_tab)%></h2>
<% if @no_data %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
  <!-- Option -->
  <%= form_tag url_for(action: :index), method: :get, id: 'query_form' do %>
    <fieldset id="filters" class="collapsible collapsed">
      <legend onclick="toggleFieldset(this);"><%= l(:label_options) %></legend>
      <div style="display: none;">
        <div class="option-col">
          <p><%= l(:label_basis_date) %></p>
          <%= text_field_tag('basis_date', @basis_date, :size => 10) %><%= calendar_for('basis_date') %>
        </div>
        <div class="option-col">
          <p><%= l(:label_basis) %></p>
          <%= check_box_tag :no_use_baseline,'true', @no_use_baseline, :onclick => "disableobject('evmbaseline_id', this.checked);"%>
          <%= label_tag l(:label_no_use_baseline) %>
          <%= select_tag :evmbaseline_id, options_from_collection_for_select(@evmbaseline, :id, :subject, @baseline_id), :disabled => @no_use_baseline %>
        </div>
        <div class="option-col">
          <p><%= l(:label_graph) %></p>
          <%= check_box_tag :forecast,'true', @forecast %><%= label_tag l(:label_forecast) %></br>
          <%= check_box_tag :display_version,'true', @display_version %><%= label_tag l(:label_display_version) %></br>
          <%= check_box_tag :display_performance,'true', @display_performance %><%= label_tag l(:label_display_performance) %></br>
        </div>
        <div class="option-col">
          <p><%= l(:label_calculate) %></p>
          <%= radio_button_tag :calcetc, 'method1', @calcetc == 'method1' %><%= label_tag l(:label_calc_method1) %></br>
          <%= radio_button_tag :calcetc, 'method2', @calcetc == 'method2' %><%= label_tag l(:label_calc_method2) %></br>
          <%= radio_button_tag :calcetc, 'method3', @calcetc == 'method3' %><%= label_tag l(:label_calc_method3) %></br>
        </div>
        <div class="option-col">
          <p><%= l(:label_Display) %></p>
          <%= check_box_tag :display_explanation, 'true', @display_explanation %><%= label_tag l(:label_display_explanation) %>
        </div>
      </div>
    </fieldset>
    <p>
      <!-- Apply button -->
      <%= link_to "#", {:onclick => "$(this).closest('form').submit()",:class => 'icon icon-checked' } do l(:button_apply) end %>
    </p>
  <% end %>
  <!--Indicator value-->
  <h3><%= l(:subtitle_evm_summary)%></h3>
  <div id="evm-suummary-wrapper">
    <%= render :partial => '/evms/measure',
        :locals => { project_evm: @project_evm } %>
  </div>
  <!--Charts-->
  <h3><%= l(:subtitle_evm_graph_main) %></h3>
  <div id="evm-charts-wrapper">
    <!-- Main Chart -->
    <div id="evm-graph-lines" class="evm-chart">
      <%= render :partial => '/evms/project_chart_js',
          :locals => { basis_date: @basis_date, project_evm: @project_evm, project_name: project_chart_name } %>
    </div>
    <!-- Incomplete issue list -->
    <fieldset id="issuelist" class="collapsible collapsed">
      <legend onclick="toggleFieldset(this);"><%= l(:subtitle_evm_incomplete_issues) %></legend>
      <div style="display: none;">
        <table class="list issue">
          <thead>
            <tr>
              <th>#</th>
              <th><%=l(:field_project)%></th>
              <th><%=l(:field_subject)%></th>
              <th><%=l(:field_status)%></th>
              <th><%=l(:field_priority)%></th>
              <th><%=l(:field_assigned_to)%></th>
              <th><%=l(:field_start_date)%></th>
              <th><%=l(:field_due_date)%></th>
              <th><%=l(:field_estimated_hours)%></th>
            </tr>
          </thead>
          <tbody>
            <% unless @incomplete_issues.nil? %>
              <% @incomplete_issues.each do |issue| %>
                <tr id="issue-<%= issue.id %>" class="<%= cycle('odd', 'even') %> <%= issue.css_classes %>">
                  <td><%=link_to(issue.id, issue_path(issue))%></td>
                  <td><%=issue.project%></td>
                  <td><%=issue.subject%></td>
                  <td><%=issue.status%></td>
                  <td><%=issue.priority%></td>
                  <td><%=issue.assigned_to%></td>
                  <td><%=issue.start_date%></td>
                  <td><%=issue.due_date%></td>
                  <td><%=issue.estimated_hours%></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </fieldset>
    <br>
    <br>
    <!-- Performance Chart -->
    <% if @display_performance %>
      <h3><%= l(:subtitle_evm_graph_performance) %></h3>
      <div id="evm-graph-lines-performance" class="evm-chart">
        <%= render :partial => '/evms/performance_chart_js',
            :locals => { basis_date: @basis_date, project_evm: @project_evm, project_name: project_chart_name } %>
      </div>
    <% end %>
    <!-- version Chart -->
    <% if @display_version %>
      <% unless @project.versions.blank? %>
        <h3><%= l(:subtitle_evm_graph_version) %></h3>
        <% @project.versions.each do |version| %>
          <% unless @version_evm[version.id].nil? %>
            <div id="evm-graph-lines-version-<%= version.id %>" class="evm-chart-<%= version.id %>"</div>
            <%= render :partial => '/evms/version_chart_js',
              :locals => { basis_date: @basis_date, version_evm: @version_evm[version.id], version: version, version_name: version_chart_name(version) } %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>
<!--Sidebar-->
<% if @display_explanation %>
  <% content_for :sidebar do %>
    <%= render :partial => '/evms/explanation' %>
  <% end %>
<% end %>
